name: Auto Delete Merged Branch

on:
  pull_request:
    types: [closed]

permissions:
  contents: write

env:
  # Branch prefixes that should NOT be auto-deleted
  PROTECTED_PREFIXES: 'main,master,develop,release/,hotfix/'

jobs:
  delete-branch:
    # Only run if the PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
      - name: Delete merged branch
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = context.payload.pull_request.head.ref;
            const headRepo = context.payload.pull_request.head.repo;
            const isFromFork = headRepo?.fork || false;
            
            // Skip if the branch is from a fork (we can't delete it)
            if (isFromFork || !headRepo) {
              console.log(`Branch '${branchName}' is from a fork or deleted fork. Skipping deletion.`);
              return;
            }
            
            // Skip if it's the default branch
            const defaultBranch = context.payload.repository.default_branch;
            if (branchName === defaultBranch) {
              console.log(`Branch '${branchName}' is the default branch. Skipping deletion.`);
              return;
            }
            
            // Protected branch prefixes that should not be auto-deleted
            const protectedPrefixes = process.env.PROTECTED_PREFIXES.split(',').map(p => p.trim());
            const isProtected = protectedPrefixes.some(prefix => branchName.startsWith(prefix));
            
            if (isProtected) {
              console.log(`Branch '${branchName}' matches protected prefix. Skipping deletion.`);
              return;
            }
            
            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branchName}`
              });
              console.log(`Successfully deleted branch '${branchName}'`);
            } catch (error) {
              // Branch might have been already deleted via GitHub settings
              if (error.status === 404) {
                console.log(`Branch '${branchName}' was already deleted`);
              } else {
                console.error(`Error deleting branch '${branchName}':`, error.message);
                throw error;
              }
            }
