name: Release

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Extract current version and calculate new version
      id: version
      run: |
        # Extract current version from CMakeLists.txt
        CURRENT_VERSION=$(grep -E '^\s*VERSION\s+[0-9]+\.[0-9]+\.[0-9]+' CMakeLists.txt | awk '{print $2}')
        
        if [ -z "$CURRENT_VERSION" ]; then
          echo "ERROR: Could not extract version from CMakeLists.txt"
          exit 1
        fi
        
        echo "Current version: $CURRENT_VERSION"
        
        # Parse version components
        MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
        MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
        PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)
        
        # Calculate new version based on bump type
        case "${{ inputs.bump_type }}" in
          major)
            NEW_VERSION="$((MAJOR + 1)).0.0"
            ;;
          minor)
            NEW_VERSION="${MAJOR}.$((MINOR + 1)).0"
            ;;
          patch)
            NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
            ;;
          *)
            echo "ERROR: Invalid bump type"
            exit 1
            ;;
        esac
        
        echo "New version: $NEW_VERSION"
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
    
    - name: Update version in CMakeLists.txt
      run: |
        sed -i 's/VERSION ${{ steps.version.outputs.current_version }}/VERSION ${{ steps.version.outputs.new_version }}/' CMakeLists.txt
        
        # Verify the change
        if ! grep -q "VERSION ${{ steps.version.outputs.new_version }}" CMakeLists.txt; then
          echo "ERROR: Failed to update version in CMakeLists.txt"
          exit 1
        fi
        
        echo "Updated CMakeLists.txt to version ${{ steps.version.outputs.new_version }}"
    
    - name: Commit version bump
      run: |
        git add CMakeLists.txt
        git commit -m "Bump version to ${{ steps.version.outputs.new_version }}"
    
    - name: Create and push tag
      run: |
        git tag -a "v${{ steps.version.outputs.new_version }}" -m "Release version ${{ steps.version.outputs.new_version }}"
        git push origin main
        git push origin "v${{ steps.version.outputs.new_version }}"
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ build-essential
    
    - name: Build library for Linux
      run: |
        mkdir -p build-linux
        cd build-linux
        cmake -DCMAKE_BUILD_TYPE=Release ..
        cmake --build . --config Release
    
    - name: Prepare release artifacts
      run: |
        # Create release directory
        mkdir -p release/datelib-${{ steps.version.outputs.new_version }}
        
        # Copy library files
        mkdir -p release/datelib-${{ steps.version.outputs.new_version }}/lib
        cp build-linux/libdatelib.so* release/datelib-${{ steps.version.outputs.new_version }}/lib/ || true
        
        # Copy headers
        mkdir -p release/datelib-${{ steps.version.outputs.new_version }}/include
        cp -r include/datelib release/datelib-${{ steps.version.outputs.new_version }}/include/
        
        # Copy LICENSE
        cp LICENSE release/datelib-${{ steps.version.outputs.new_version }}/
        
        # Create README for the release
        cat > release/datelib-${{ steps.version.outputs.new_version }}/README.txt << EOF
        datelib v${{ steps.version.outputs.new_version }}
        
        C++ library of date utilities
        
        This package contains:
        - lib/: Compiled shared library files
        - include/datelib/: Public header files
        - LICENSE: Apache 2.0 license
        
        To use this library in your project:
        1. Copy the include/datelib directory to your include path
        2. Copy the lib/libdatelib.so to your library path
        3. Link against libdatelib in your build system
        
        For more information, visit: https://github.com/${{ github.repository }}
        EOF
        
        # Create tarball
        cd release
        tar -czf datelib-${{ steps.version.outputs.new_version }}-linux-x86_64.tar.gz datelib-${{ steps.version.outputs.new_version }}
        
        # Create zip archive
        zip -r datelib-${{ steps.version.outputs.new_version }}-linux-x86_64.zip datelib-${{ steps.version.outputs.new_version }}
    
    - name: Generate release notes
      id: release_notes
      run: |
        # Get commits since last tag
        LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -z "$LAST_TAG" ]; then
          COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
        else
          COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
        fi
        
        # Create release notes
        cat > release_notes.md << EOF
        # Release v${{ steps.version.outputs.new_version }}
        
        This is a ${{ inputs.bump_type }} version release of datelib.
        
        ## Changes
        $COMMITS
        
        ## Installation
        
        Download the appropriate artifact for your platform and extract it.
        
        ### Linux
        \`\`\`bash
        tar -xzf datelib-${{ steps.version.outputs.new_version }}-linux-x86_64.tar.gz
        \`\`\`
        
        ## Usage
        
        Include the headers in your project:
        \`\`\`cpp
        #include <datelib/date.h>
        \`\`\`
        
        Link against the library in your build system (CMake example):
        \`\`\`cmake
        target_link_libraries(your_target PRIVATE datelib)
        \`\`\`
        EOF
        
        echo "Release notes generated"
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.new_version }}
        name: Release v${{ steps.version.outputs.new_version }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          release/datelib-${{ steps.version.outputs.new_version }}-linux-x86_64.tar.gz
          release/datelib-${{ steps.version.outputs.new_version }}-linux-x86_64.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
